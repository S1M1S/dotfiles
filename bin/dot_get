#!/bin/bash

function get_ruby {
  # set up rbenv and ruby-build

  echo "Checking rbenv install..."
  RBENV_DIR="$HOME/.rbenv"
  # but if we already have rbenv, then use that directory
  rbenv root &> /dev/null && RBENV_DIR="$(rbenv root)"
  if command -v rbenv &> /dev/null; then
    echo "rbenv is already installed. Updating..."
    git -C "$RBENV_DIR" pull
  else
    echo "rbenv not installed. Getting..."
    RBENV_GIT="https://github.com/rbenv/rbenv.git"

    git clone "$RBENV_GIT" "$RBENV_DIR"

    echo "Attempting to compile dynamic bash extension..."
    (cd "$RBENV_DIR" && src/configure && make -C src)
  fi

  echo "Checking ruby-build install..."
  RBENV_PLUGIN_DIR="$RBENV_DIR/plugins"
  RUBY_BUILD_DIR="$RBENV_PLUGIN_DIR/ruby-build"
  if [[ -d "$RUBY_BUILD_DIR" ]]; then
    echo "ruby-build is already installed. Updating..."
    git -C "$RUBY_BUILD_DIR" pull
  else
    echo "ruby-build not installed. Getting..."
    RUBY_BUILD_GIT="https://github.com/rbenv/ruby-build.git"
    mkdir -p "$RBENV_PLUGIN_DIR"
    git clone "$RUBY_BUILD_GIT" "$RUBY_BUILD_DIR"
  fi

  . ali refresh

  V3="$(rbenv install --list &> /dev/null | grep '^3')"
  V2_7="$(rbenv install --list &> /dev/null | grep '^2\.7')"

  rbenv install "$V2_7" -s
  rbenv install "$V3" -s

  echo "Setting global ruby to $V3"
  rbenv global "$V3"
}

function get_neovim {
  # TODO: install neovim here

  if command -v yay &> /dev/null; then
    yay -S --needed --noconfirm wl-clipboard
    yay -S --needed --noconfirm python
    yay -S --needed --noconfirm python-pip
  fi

  echo "Installing Ruby provider..."
  gem install neovim &

  echo "Installing Python provider..."
  sudo pip install pynvim &

  echo "Installing Node.js provider..."
  npm install -g neovim &

  echo "Installing packer..."
  git clone https://github.com/wbthomason/packer.nvim\
   ~/.local/share/nvim/site/pack/packer/start/packer.nvim &

  wait
}

if [[ $1 = "ruby" ]]; then
  get_ruby
elif [[ $1 = "neovim" ]]; then
  get_neovim
fi
